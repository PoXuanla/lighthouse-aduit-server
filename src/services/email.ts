// Email service for sending audit reports

import nodemailer from 'nodemailer'
import { AuditResult } from '../types.js'
import { GMAIL_USER, GMAIL_APP_PASSWORD, GMAIL_TO } from '../config.js'

// Generate HTML email content
function generateEmailHtml(result: AuditResult, isPartialResult = false, errorCode?: number | null): string {
  const passEmoji = 'âœ…'
  const failEmoji = 'âŒ'
  
  const perfStatus = result.summary.performance >= 80 ? passEmoji : failEmoji
  const seoStatus = result.summary.seo >= 90 ? passEmoji : failEmoji

  let pagesHtml = ''
  for (const page of result.pages) {
    const perfColor = (page.performance ?? 0) >= 80 ? '#22c55e' : '#ef4444'
    const seoColor = (page.seo ?? 0) >= 90 ? '#22c55e' : '#ef4444'
    
    pagesHtml += `
      <tr>
        <td style="padding: 8px; border-bottom: 1px solid #e5e7eb;">${page.path}</td>
        <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center; color: ${perfColor}; font-weight: bold;">${page.performance}</td>
        <td style="padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: center; color: ${seoColor}; font-weight: bold;">${page.seo}</td>
      </tr>
    `
  }

  let failedHtml = ''
  if (result.failedPages.length > 0) {
    failedHtml = `
      <h3 style="color: #ef4444; margin-top: 24px;">âš ï¸ Pages Below Threshold (${result.failedPages.length})</h3>
      <ul style="color: #6b7280;">
        ${result.failedPages.map(p => `<li><strong>${p.path}</strong> - Performance: ${p.performance}, SEO: ${p.seo}</li>`).join('')}
      </ul>
    `
  }

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
    </head>
    <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f9fafb;">
      <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h1 style="color: #111827; margin-bottom: 8px;">ğŸ” Unlighthouse Audit Report</h1>
        <p style="color: #6b7280; margin-top: 0;">
          <strong>URL:</strong> ${result.url}<br>
          <strong>Time:</strong> ${new Date(result.timestamp).toLocaleString()}
        </p>
        
        ${isPartialResult ? `
        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 16px; margin: 16px 0;">
          <h3 style="color: #92400e; margin-top: 0; margin-bottom: 8px;">âš ï¸ éƒ¨åˆ†çµæœè­¦å‘Š</h3>
          <p style="color: #78350f; margin: 0;">
            æ­¤å¯©è¨ˆå ±å‘Šç‚º<strong>éƒ¨åˆ†å®Œæˆçµæœ</strong>ã€‚Lighthouse åœ¨æƒæéç¨‹ä¸­é‡åˆ°äº†ä¸€äº›å•é¡Œä¸¦æå‰åœæ­¢ï¼ˆé€€å‡ºä»£ç¢¼: ${errorCode}ï¼‰ï¼Œ
            ä½†ä»æˆåŠŸç”Ÿæˆäº†éƒ¨åˆ†é é¢çš„å¯©è¨ˆæ•¸æ“šã€‚è«‹æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒä»¥äº†è§£å…·é«”å•é¡Œï¼Œä¸¦è€ƒæ…®é‡æ–°åŸ·è¡Œå®Œæ•´å¯©è¨ˆã€‚
          </p>
        </div>
        ` : ''}
        
        <h2 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">ğŸ“Š Summary</h2>
        <div style="display: flex; gap: 24px; margin-bottom: 24px;">
          <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; flex: 1; text-align: center;">
            <div style="font-size: 36px; font-weight: bold; color: ${result.summary.performance >= 80 ? '#22c55e' : '#ef4444'};">
              ${result.summary.performance}
            </div>
            <div style="color: #6b7280;">Performance ${perfStatus}</div>
            <div style="font-size: 12px; color: #9ca3af;">Target: â‰¥80</div>
          </div>
          <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; flex: 1; text-align: center;">
            <div style="font-size: 36px; font-weight: bold; color: ${result.summary.seo >= 90 ? '#22c55e' : '#ef4444'};">
              ${result.summary.seo}
            </div>
            <div style="color: #6b7280;">SEO ${seoStatus}</div>
            <div style="font-size: 12px; color: #9ca3af;">Target: â‰¥90</div>
          </div>
        </div>

        ${failedHtml}

        <h2 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; margin-top: 24px;">ğŸ“„ All Pages (${result.pages.length})</h2>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f3f4f6;">
              <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">Page</th>
              <th style="padding: 12px 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">Performance</th>
              <th style="padding: 12px 8px; text-align: center; border-bottom: 2px solid #e5e7eb;">SEO</th>
            </tr>
          </thead>
          <tbody>
            ${pagesHtml}
          </tbody>
        </table>

        <p style="color: #9ca3af; font-size: 12px; margin-top: 24px; text-align: center;">
          Generated by Audit Server â€¢ Powered by Unlighthouse
        </p>
      </div>
    </body>
    </html>
  `
}

// Send error notification email
export async function sendErrorNotificationEmail(url: string, errorCode: number | null, errorDetails?: string): Promise<boolean> {
  if (!GMAIL_USER || !GMAIL_APP_PASSWORD || !GMAIL_TO) {
    console.error('[Email] Missing Gmail configuration. Set GMAIL_USER, GMAIL_APP_PASSWORD, and GMAIL_TO in .env')
    return false
  }

  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: GMAIL_USER,
      pass: GMAIL_APP_PASSWORD
    }
  })

  const subject = `âŒ [Audit Error] ${url} - Lighthouse å¯©è¨ˆå¤±æ•— (é€€å‡ºä»£ç¢¼: ${errorCode})`
  
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
    </head>
    <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f9fafb;">
      <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #ef4444;">
        <h1 style="color: #dc2626; margin-bottom: 8px;">âŒ Lighthouse å¯©è¨ˆå¤±æ•—</h1>
        <p style="color: #6b7280; margin-top: 0;">
          <strong>URL:</strong> ${url}<br>
          <strong>æ™‚é–“:</strong> ${new Date().toLocaleString()}<br>
          <strong>é€€å‡ºä»£ç¢¼:</strong> ${errorCode}
        </p>
        
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 16px; margin: 16px 0;">
          <h3 style="color: #991b1b; margin-top: 0; margin-bottom: 8px;">éŒ¯èª¤è©³æƒ…</h3>
          <p style="color: #7f1d1d; margin: 0; font-family: monospace; font-size: 14px;">
            ${errorDetails ? errorDetails.replace(/\n/g, '<br>') : 'å¯©è¨ˆéç¨‹ä¸­é‡åˆ°æœªçŸ¥éŒ¯èª¤'}
          </p>
        </div>

        <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 16px; margin: 16px 0;">
          <h3 style="color: #0369a1; margin-top: 0; margin-bottom: 8px;">ğŸ”§ å»ºè­°æ’æŸ¥æ­¥é©Ÿ</h3>
          <ul style="color: #0c4a6e; margin: 0; padding-left: 20px;">
            <li>æª¢æŸ¥ç›®æ¨™ç¶²ç«™æ˜¯å¦å¯æ­£å¸¸è¨ªå•</li>
            <li>ç¢ºèªç¶²è·¯é€£æ¥æ­£å¸¸</li>
            <li>æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒä¸­çš„è©³ç´°éŒ¯èª¤ä¿¡æ¯</li>
            <li>é‡æ–°è§¸ç™¼å¯©è¨ˆè«‹æ±‚</li>
          </ul>
        </div>

        <p style="color: #9ca3af; font-size: 12px; margin-top: 24px; text-align: center;">
          ç”± Audit Server è‡ªå‹•ç™¼é€ â€¢ å¦‚éœ€é‡æ–°å¯©è¨ˆï¼Œè«‹é‡æ–°ç™¼é€ API è«‹æ±‚
        </p>
      </div>
    </body>
    </html>
  `

  try {
    await transporter.sendMail({
      from: GMAIL_USER,
      to: GMAIL_TO,
      subject,
      html: htmlContent
    })
    console.log(`[Email] Error notification sent to ${GMAIL_TO}`)
    return true
  } catch (error) {
    console.error('[Email] Failed to send error notification:', error)
    return false
  }
}

// Send email with audit results
export async function sendAuditEmail(result: AuditResult, isPartialResult = false, errorCode?: number | null): Promise<boolean> {
  if (!GMAIL_USER || !GMAIL_APP_PASSWORD || !GMAIL_TO) {
    console.error('[Email] Missing Gmail configuration. Set GMAIL_USER, GMAIL_APP_PASSWORD, and GMAIL_TO in .env')
    return false
  }

  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: GMAIL_USER,
      pass: GMAIL_APP_PASSWORD
    }
  })

  const perfStatus = result.summary.performance >= 80 ? 'âœ…' : 'âŒ'
  const seoStatus = result.summary.seo >= 90 ? 'âœ…' : 'âŒ'
  
  // å¦‚æœæ˜¯éƒ¨åˆ†çµæœï¼Œåœ¨ä¸»æ—¨ä¸­æ·»åŠ è­¦å‘Šæ¨™è¨˜
  const warningPrefix = isPartialResult ? 'âš ï¸ [Partial] ' : ''
  const subject = `${warningPrefix}[Audit] ${result.url} - Performance: ${result.summary.performance} ${perfStatus} | SEO: ${result.summary.seo} ${seoStatus}`

  try {
    await transporter.sendMail({
      from: GMAIL_USER,
      to: GMAIL_TO,
      subject,
      html: generateEmailHtml(result, isPartialResult, errorCode)
    })
    console.log(`[Email] Report sent to ${GMAIL_TO}`)
    return true
  } catch (error) {
    console.error('[Email] Failed to send email:', error)
    return false
  }
}
